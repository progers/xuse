<!DOCTYPE HTML>
<html>
<head>
<style>

</style>
<script>
  var XUsePrototype = Object.create(SVGGraphicsElement.prototype);
  XUsePrototype._updateHrefAttribute = function(forceReclone) {
    var href = this.getAttributeNS('http://www.w3.org/1999/xlink', 'href');
    if (!href)
      return;
    var hrefElement = document.querySelector(href);
    if (forceReclone || this._targetElement != hrefElement) {
      this._targetElement = hrefElement;
      this.shadowRoot.appendChild(hrefElement.cloneNode(true));
    }
  };
  XUsePrototype._updateXAttribute = function() {
    var x = this.getAttribute('x');
    if (!x)
      return;
    console.log('updating x: ' + x);
  };
  XUsePrototype._updateYAttribute = function() {
    var y = this.getAttribute('y');
    if (!y)
      return;
    console.log('updating y: ' + y);
  };
  XUsePrototype._updateWidthAttribute = function() {
    var width = this.getAttribute('width');
    if (!width)
      return;
    console.log('updating width: ' + width);
  };
  XUsePrototype._updateHeightAttribute = function() {
    var height = this.getAttribute('height');
    if (!height)
      return;
    console.log('updating height: ' + height);
  };
  XUsePrototype.createdCallback = function() {
    this.createShadowRoot();
    this._updateHrefAttribute();
    this._updateXAttribute();
    this._updateYAttribute();
    this._updateWidthAttribute();
    this._updateHeightAttribute();
  };
  XUsePrototype.attributeChangedCallback = function(attributeName, oldValue, newValue) {
    switch (attributeName) {
      // FIXME: attributeChangedCallback doesn't support namespaces so we have to check for both xlink:href and href.
      case('xlink:href'):
      case('href'):
        this._updateHrefAttribute();
        break;
      case('x'):
        this._updateXAttribute();
        break;
      case('y'):
        this._updateYAttribute();
        break;
      case('width'):
        this._updateWidthAttribute();
        break;
      case('height'):
        this._updateHeightAttribute();
        break;
    }
  };
  
  Object.defineProperty(XUsePrototype, "x", {
    get: function() { console.log('x getter'); return this._x || 0; },
    set: function(newValue) { console.log('x setter'); this._x = newValue},
    enumerable: true,
    configurable: true});
  var xuse = document.registerElement('x-use', {
    prototype: XUsePrototype,
    extends: 'g' // FIXME: for testing only. This should be 'use'.
  });
</script>
</head>
<body>
<h2>SVG &lt;use&gt; using shadow dom</h2>
<h3>Regular use:</h3>
<svg width="120px" height="120px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <defs>
    <rect id="rect" width="100" height="100" fill="green"/>
  </defs>
  <use x="0" y="0" xlink:href="#rect" />
</svg>
<h3>Shadow use:</h3>
<svg width="120px" height="120px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <defs>
    <rect id="murect" width="100" height="100" fill="green"/>
  </defs>
  <g is="x-use" id="mu" x="0" y="0" xlink:href="#murect" />
</svg>
</body>
</html>

